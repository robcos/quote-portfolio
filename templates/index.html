<html>
<head>
<title>My stocks</title>
<script src="/js/jquery-1.4.4.min.js"></script> 

<script>
  function deleteRow(key, row) {
    if (!confirm("Are you sure you want to delete this row?")) {
      return;
    }
    $.ajax({
      url: key,
      type: 'DELETE',
      success: function(result) {
          $(row).closest('tr').fadeOut();
      },
      error: function(result) {
          $('#status').html(result.responseText);
      },
    });
  }

  $(document).ready(function() { 
    hideTransactionIfNeeded();
    $(window).bind('hashchange', function(event) {
      hideTransactionIfNeeded();
    });
  });

  function hideTransactionIfNeeded() {
    var hash = window.location.hash;
     if (hash == "#showTransactions") {
      $('.transaction').fadeIn();
    } else {
      $('.transaction').hide();
    }
    $('form').attr('action', function() {
      this.action = this.action.replace(/#.*/, '') + hash;
    });
    $('a').attr('href', function() {
      this.href = this.href.replace(/#.*/, '') + hash;
    });
  }
  
  function toggleTransactions() {
    if (window.location.hash == "#showTransactions") {
      $('.transaction').fadeOut();
      location.hash='';
    } else {
      $('.transaction').fadeIn();
      location.hash='showTransactions';
    }
    return false;
  }

  function today() {
    var now = new Date();
    var today = now.getFullYear() + "-" + (1 + now.getMonth()) + "-" + now.getDate();
    $('#id_date').attr('value', today);
    return false;
  }

  function setStop(key) {
    $.ajax({
      url: '/transaction/' + key + '/json',
      type: 'GET',
      success: function(result) {
          $('#id_stop').attr('value', result.suggested_stop);
      }
    });
    return false;
  }

  function setPosition(key) {
    $.ajax({
      url: '/transaction/' + key + '/json',
      type: 'GET',
      success: function(result) {
          $('#id_quantity_list').attr('value', result.suggested_position);
      }
    });
    return false;
  }
</script>
</script>
<style>
  body {
    font-family: monospace;
    font-size: 12px;
  }
  .errorlist {
    display:inline;
    margin: 0;
    padding: 0;
  }
  .errorlist li {
    background-color: red;
    color: white;
    display: inline;
    font-size: 1em;
    margin: 0;
    padding: 2px;;
    text-align:left;
  }

  table {
    margin: 2em;
    border: 1px solid gray;
  }
  
  table caption {
    text-align:left;
  }

  th {
    text-align:right;
    white-space:nowrap;
  }

  tr.row1 td {
    background-color: #FFFFCC;
  }

  .portfolio td {
    text-align:right;
    white-space:nowrap;
  }

  .negative {
    color: red;
  }
  .inline {
    display:inline;
  }
</style>
</style>
</head>
<body>
<div id="status"></div>
<a href="?show_closed=true">Show closed positions</a>
<a href="?show_closed=false">Show only open positions</a>
<a href="/download/quotes">Get quotes</a>
<a href="/download/historical_quotes">Get historical quotes</a>
<a href="/download/currencies">Get currencies</a>
<a href="#" onclick="return toggleTransactions()">Toggle transactions</a>
{% for portfolio in portfolios %}
<table border="1" class="portfolio">
<caption>Portfolio: {{portfolio.name}} - R={{portfolio.risk_unit}}
<form class="inline" action="/cash" method="POST">
<input name="key" type="hidden" value="{{portfolio.key}}"/>
Cash<input name="cash" value="{{portfolio.cash}}" size="6"/>{{portfolio.currency}}
- Other<input name="other" value="{{portfolio.other}}" size="6"/>{{portfolio.currency}}
- Nominal Value<input name="nominal_value" value="{{portfolio.nominal_value}}" size="6"/>{{portfolio.currency}}
<input type="submit" value="Update"/></form>
</caption>
<tr>
<th></th>
<th>Symbol</th>
<th>Date</th>
{# <th>Enter Date</th> #}
{# <th>Value</th> #}
<th>Value</th>
<th title="Includes an estimate exit fee">Cost</th>
<th>Gain</th>
<th>Gain %</th>
<th>Risk</th>
<th>RTR</th>
<th>Shares</th>
<th>Enter Price</th>
<th>Price</th>
<th>Change</th>
<th>Stop</th>
<th>Sugg stop</th>
<th>Sugg pos</th>
<th>ATR 20</th>
<th>Ent.ATR</th>
<th>LL 10</th>
</tr>

{% for position in portfolio.GetAllPositions %}
<tr class="position {% cycle 'row1' 'row2' as rowcolor %}">
{% if not position.GetTransactions %}
<td><a href="#" onclick="return deleteRow('/position/{{position.key}}', this)">D</a></td>
{% else %}
<td></td>
{% endif %}
<td><a href="/position/{{position.key}}">{{position.symbol}}</a></td>
<td>{{position.realtime_quote.date}}</td>
{# <td>{{position.enter_date}}</td> #}
<td title="{{ position.value|stringformat:'.2f' }} {{position.currency}}">{{ position.GetValue|stringformat:'.2f' }}</td>
<td>{{ position.GetTotalBuyingCost|stringformat:'.2f' }}</td>
<td{% if position.loosing %} class="negative"{% endif %}>{{ position.GetGain|stringformat:'.2f' }}</td>
<td{% if position.loosing %} class="negative"{% endif %}>{{ position.GetGainPercentage|stringformat:'2.1f%%' }}</td>
<td{% if position.too_risky %} class="negative"{% endif %}>{{ position.GetRisk|stringformat:'.2f' }}</td>
<td{% if position.below_stop %} class="negative"{% endif %}>{{position.GetRtr|stringformat:'.2f' }}</td>
<td>{{position.GetOutstandingShares }}</td>
<td>{{position.GetShareAveragePrice|stringformat:'.2f' }}</td>
<td>{{position.realtime_quote.price|stringformat:'.2f' }}</td>
<td>{{position.realtime_quote.change}}</td>
<td{% if position.below_stop %} class="negative"{% endif %}>{{position.GetStop|stringformat:'.2f' }}</td>
<td title="enter price - 3 times the enter atr 20">{{position.suggested_stop|stringformat:'.2f' }}</td>
<td title="">{{position.suggested_shares|stringformat:'.0f' }}</td>
<td>{{ position.GetAtr20|stringformat:'.2f' }}</td>
<td>{{ position.GetAtr20AtEnter|stringformat:'.2f' }}</td>
<td{% if position.below_ll_10  %} class="negative"{% endif %}>{{position.ll_10|stringformat:'.2f' }}</td>
</tr>

{% for transaction in position.GetTransactions %}
<tr class="transaction {{ rowcolor }}">
<td><a href="#" onclick="return deleteRow('/transaction/{{transaction.key}}', this)">D</a></td>
<td>{% if transaction.is_buying %}Bought{% else %}Sold{% endif %}</td>
<td><a href="/transaction/{{transaction.key}}">{{transaction.date}}</a></td>
<td></td>
<td>{{transaction.GetCost }}</td>
<td></td>
<td></td>
<td{% if transaction.too_risky %} class="negative"{% endif %}>{{ transaction.GetRisk|stringformat:'.2f' }}</td>
<td></td>
<td>{% if not transaction.is_buying %}-{% endif %}{{ transaction.GetQuantity}}</td>
<td title="Average cost: {{ transaction.GetAverageCost|stringformat:'0.2f' }}">
  {{ transaction.GetAveragePrice|stringformat:'0.2f' }}</td>
<td></td>
<td></td>
<td>{{transaction.stop|stringformat:'0.2f' }}</td>
<td>{{ transaction.GetSuggestedStop|stringformat:'0.2f' }}</td>
<td>{{ transaction.GetSuggestedPosition|stringformat:'0.2f' }}</td>
<td>{{ transaction.GetAtr20|stringformat:'0.2f' }}</td>
<td>{{ transaction.GetAtr20AtEnter|stringformat:'0.2f' }}</td>
<td>{{ transaction.GetLL10|stringformat:'0.2f' }}</td>
</tr>
{% endfor %}

{% endfor %}
<tr>
<th colspan="3">Total</th>
<td>{{ portfolio.GetValue|stringformat:'.2f' }}</td>
<td>{{ portfolio.cost|stringformat:'.2f' }}</td>
<td{% if portfolio.loosing %} class="negative"{% endif %}>{{ portfolio.gain|stringformat:'.2f' }}</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>

</table>

{% endfor %}
<table border=1>
<caption>Currencies</caption>
<tr>
<th>Symbol</th>
<th>Rate</th>
<th>Date</th>
</tr>
{% for currency in currencies %}
<tr>
<td>{{currency.symbol}}</td>
<td>{{currency.rate}}</td>
<td>{{currency.date}}</td>
</tr>
{% endfor %}
</table>
<div id="menu">
<a href="/position">Add position</a>
<a href="/transaction">Add transaction</a>
</div>

{% if transaction_form %}
<form action="/transaction/{{transaction_form.instance.key}}" method="POST">
<table border="0">
<caption>Add a new transaction</caption>
<tr class="fieldWrapper">
  <td colspan="2">{{transaction_form.non_field_errors}}</td>
</tr>
<tr class="fieldWrapper">
  <th><label for="id_position">Position</label></th>
  <td>{{ transaction_form.position }} {{transaction_form.position.errors}}</td>
</tr>
<tr class="fieldWrapper">
  <th><label for="id_is_buying">Buying</label></th>
  <td>{{ transaction_form.is_buying }} {{transaction_form.is_buying.errors}}</td>
</tr>
<tr class="fieldWrapper">
  <th><label for="id_quantity_list">Quantities</label></th>
  <td>{{ transaction_form.quantity_list }} {{transaction_form.quantity_list.errors}}<a onclick="return setPosition('{{transaction_form.instance.key}}')">Copy</a></td>
</tr>
<tr class="fieldWrapper">
  <th><label for="id_price_list">Enter prices</label></th>
  <td>{{ transaction_form.price_list }} {{transaction_form.price_list.errors}}</td>
</tr>
<tr class="fieldWrapper">
  <th><label for="id_stop">Stop</label></th>
  <td>{{ transaction_form.stop }} {{transaction_form.stop.errors}}<a onclick="return setStop('{{transaction_form.instance.key}}')">Copy</a></td>
</tr>
<tr class="fieldWrapper">
  <th><label for="id_date">Date</label></th>
  <td>{{ transaction_form.date }} {{transaction_form.date.errors}}<a onclick="return today()">Today</a></td>
</tr>
<tr class="fieldWrapper">
  <th><label for="id_fees">Fees</label></th>
  <td>{{ transaction_form.fees }} {{transaction_form.fees.errors}}</td>
</tr>
<tr class="fieldWrapper">
  <th><label for="id_taxes">Taxes</label></th>
  <td>{{ transaction_form.taxes }} {{transaction_form.taxes.errors}}</td>
</tr>
{% comment %}
<tr class="fieldWrapper">
  <th><label for="id_currency">Currency</label></th>
  <td>{{ transaction_form.currency }} {{transaction_form.currency.errors}}</td>
</tr>
<tr class="fieldWrapper">
  <th><label for="id_currency_rate">Currency rate</label></th>
  <td>{{ transaction_form.currency_rate }} {{transaction_form.currency_rate.errors}}</td>
</tr>
<tr><th>Position exit</th></tr>
<tr class="fieldWrapper">
  <th><label for="id_exit_date">Exit date</label></th>
  <td>{{ transaction_form.exit_date }} {{transaction_form.exit_date.errors}}</td>
</tr>
<tr class="fieldWrapper">
  <th><label for="id_exit_commission">Exit commission</label></th>
  <td>{{ transaction_form.exit_commission }} {{transaction_form.exit_commission.errors}}</td>
</tr>
<tr class="fieldWrapper">
  <th><label for="id_exit_price">Exit price</label></th>
  <td>{{ transaction_form.exit_price }} {{transaction_transaction_form.exit_price.errors}}</td>
</tr>
{% endcomment %}
<tr><th></th>
<td><input type="submit" value="save"></td>
</table>
</form>
{% endif %}

{% if position_form %}
<form action="/position/{{position_form.instance.key}}" method="POST">
<table border="0">
<caption>Add a new position</caption>
<tr class="fieldWrapper">
  <th><label for="id_portfolio">Portfolio</label></th>
  <td>{{ position_form.portfolio }} {{position_form.portfolio.errors}}</td>
</tr>
<tr class="fieldWrapper">
  <th><label for="id_symbol">Symbol</label></th>
  <td>{{ position_form.symbol }} {{position_form.symbol.errors}} {{position_form.non_field_errors}}</td>
</tr>
<tr class="fieldWrapper">
  <th><label for="id_closed">Closed</label></th>
  <td>{{ position_form.closed }} {{position_form.closed.errors}}</td>
</tr>
<td><input type="submit" value="save"></td>
</table>
</form>
{% endif %}
<form action="/position/{{position_form.instance.key}}" method="POST">
</body>
</html>
